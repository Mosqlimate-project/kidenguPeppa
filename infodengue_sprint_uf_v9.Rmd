---
title: "2024 Infodengue Sprint"
author: Fernanda Valente, Luiz Max Carvalho e Marcio Bastos
output: 
  html_document:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: false
    df_print: paged
    highlight: tango
    toc: yes
    toc_depth: 6
    toc_float: yes
  html_notebook:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: false
    df_print: paged
    highlight: tango
    toc: yes
    toc_depth: 6
    toc_float: yes
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

```{r setup, include=FALSE , warning = FALSE}
library(rmdformats)
knitr::opts_chunk$set(echo = TRUE, tidy=TRUE, cache=FALSE)
options(knitr.kable.NA = '')
options(knitr.table.format = 'html')
```

```{r preamble, warning=FALSE, message=FALSE}
library(readr)
library(tidyr)
library(INLA)
library(lubridate)
library(ggplot2)
library(tidyverse)
library(viridis)
library(sf)
library(xts)
library(plotly)
library(gridExtra)
library(pracma)
library(knitr)
library(kableExtra)
library(dplyr)

setwd("C:/Users/Fernanda/Dropbox/FGV/Documentos/ProjetoEMAp")
pop <- read.table("pred_ibge.csv", header = TRUE, sep = ",")
source("functions.R")
```

# Models

## Model 1 - Weekly and yearly (iid) components

The first model is founded on a structural decomposition designed for modeling counting series, employing a Poisson distribution framework. Within this distribution, the log intensity undergoes variations over time, defined by the sum of weekly and yearly components. Utilizing a Poisson process structure with stochastic intensity implies that the process is characterized by a Cox process.

The weekly component is defined through a first-order autoregressive process, while the yearly component assumed to be independently and identically distributed. The proposed model is expressed as follows:

$$
\begin{align} 
Y_t&=Poisson(\exp(\lambda_t)), \nonumber \\
\lambda_t &= \gamma_t(week) + \delta_t(year)   \nonumber \\
\gamma_t(week) &= \beta \gamma_{t-1}(week) + \eta_{\gamma}, \quad \text{week} = 1, \ldots, 52 \nonumber \\
\delta_t(year) &\overset{\mathrm{iid}}{\sim} N(0, \sigma^2_{\eta_{\delta}}), \quad \text{year} = 2010, \ldots, 2023  \ 
\end{align}
$$ 

\begin{itemize}
\item $Y_t$: the number of occurrences in time $t$;
\item $\gamma_t(week)$: weekly component;
\item $\delta_t(year)$: yearly component;
\end{itemize}

The resulting Bayesian hierarchical structure allows us to perform inference procedure within the INLA framework, which provides accurate and efficient approximations on Bayesian hierarchical models that can be represented as latent Gaussian models.

## Model 2 - Weekly and yearly (RW1) components

The second proposed model is similar to the first one but models the yearly component as a random walk instead of assuming it to be independently and identically distributed. The weekly component remains modeled as a first-order autoregressive process.

$$
\begin{align} 
Y_t&=Poisson(\exp(\lambda_t)), \nonumber \\
\lambda_t &= \gamma_t(week) + \delta_t(year)   \nonumber \\
\gamma_t(week) &= \beta \gamma_{t-1}(week) + \eta_{\gamma}, \quad \text{week} = 1, \ldots, 52 \nonumber \\
\delta_t(year) &=  \delta_{t-1}(year) + \eta_{\delta}, \quad \text{year} = 2010, \ldots, 2023  \ 
\end{align}
$$ 

\begin{itemize}
\item $Y_t$: the number of occurrences in time $t$;
\item $\gamma_t(week)$: weekly component;
\item $\delta_t(year)$: yearly component;
\end{itemize}

```{r}
write.table(data.frame(date = character(), mean_prediction = numeric(), lower_interval = numeric(), upper_interval = numeric(), adm_1 = character()), 
            file = "validation_test1_model1.csv", 
            row.names = FALSE, col.names = TRUE, sep = ",")

write.table(data.frame(date = character(), mean_prediction = numeric(), lower_interval = numeric(), upper_interval = numeric(), adm_1 = character()), 
            file = "validation_test1_model2.csv", 
            row.names = FALSE, col.names = TRUE, sep = ",")

write.table(data.frame(date = character(), mean_prediction = numeric(), lower_interval = numeric(), upper_interval = numeric(), adm_1 = character()), 
            file = "validation_test2_model1.csv", 
            row.names = FALSE, col.names = TRUE, sep = ",")

write.table(data.frame(date = character(), mean_prediction = numeric(), lower_interval = numeric(), upper_interval = numeric(), adm_1 = character()), 
            file = "validation_test2_model2.csv", 
            row.names = FALSE, col.names = TRUE, sep = ",")
```

# Model comparison metrics

## WIS

The WIS (Weighted Interval Score) is a performance metric used for evaluating the accuracy of probabilistic forecasts. (...)

```{r}
resultados_melhores_modelos <- data.frame(
  Estado = character(),
  Validacao1 = character(),
  Validacao2 = character(),
  WIS_Validacao1 = numeric(),
  WIS_Validacao2 = numeric(),
  Delta_WIS_Validacao1 = numeric(),
  Delta_WIS_Validacao2 = numeric(),
  stringsAsFactors = FALSE
)

adicionar_resultado <- function(estado, validacao1, validacao2, summarised_scores_validacao1, summarised_scores_validacao2) {
  
  best_wis_validacao1 <- summarised_scores_validacao1 %>%
    filter(model == validacao1) %>%
    summarise(total_wis = sum(wis)) %>%
    pull(total_wis)
  
  best_wis_validacao2 <- summarised_scores_validacao2 %>%
    filter(model == validacao2) %>%
    summarise(total_wis = sum(wis)) %>%
    pull(total_wis)

  second_best_wis_validacao1 <- summarised_scores_validacao1 %>%
    filter(model != validacao1) %>%
    summarise(second_best_wis = sum(wis)) %>%
    pull(second_best_wis)
  
  second_best_wis_validacao2 <- summarised_scores_validacao2 %>%
    filter(model != validacao2) %>%
    summarise(second_best_wis = sum(wis)) %>%
    pull(second_best_wis)

  delta_wis_validacao1 <- second_best_wis_validacao1 - best_wis_validacao1
  delta_wis_validacao2 <- second_best_wis_validacao2 - best_wis_validacao2

  novo_resultado <- data.frame(
    Estado = estado,
    Validacao1 = validacao1,
    Validacao2 = validacao2,
    WIS_Validacao1 = best_wis_validacao1,
    WIS_Validacao2 = best_wis_validacao2,
    Delta_WIS_Validacao1 = delta_wis_validacao1,
    Delta_WIS_Validacao2 = delta_wis_validacao2,
    stringsAsFactors = FALSE
  )
  
  resultados_melhores_modelos <<- rbind(resultados_melhores_modelos, novo_resultado)
}

extract_credible_intervals <- function(marginals_random, effect_name, model_name) {
  results_list <- list()
  
  n_effects <- length(marginals_random[[effect_name]])
  
  for (idx in 1:n_effects) {
    random_effect_marginal <- marginals_random[[effect_name]][[idx]]
    
    median_value <- inla.qmarginal(0.5, random_effect_marginal)
    lower_ci <- inla.qmarginal(0.025, random_effect_marginal)
    upper_ci <- inla.qmarginal(0.975, random_effect_marginal)
    
    results_list[[idx]] <- data.frame(
      Effect = idx,
      Median = median_value,
      Lower_CI = lower_ci,
      Upper_CI = upper_ci,
      Model = model_name,
      Effect_Type = effect_name
    )
  }
  
  do.call(rbind, results_list)
}

```

# North

## Amazonas
### Data

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
uf_name <- "AM"
data <- read.table("dados_dengue_AM_10_24.csv", header = TRUE, sep = ",")
data <- distinct(data) %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(incidence_rate = (casos/pop)*1e5) %>% 
  transmute(
    data_iniSE = as.Date(data_iniSE),
    cases = casos,
    pop = pop,
    umidmed = umidmed,
    tempmed = tempmed,
    week = week,
    Year = Year,
    incidence_rate = incidence_rate
  )
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(data)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors_full <- create_latent_factors(agg_data, "cases")

latent_factors_full <- latent_factors_full %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(year = Year - min(Year) + 1) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")

p <- ggplot(agg_data, aes(x = as.Date(data_iniSE), y = cases/pop*1e5)) +
   geom_bar(stat = "identity", fill = "pink") +
   theme_minimal() +
   labs(title = paste("Dengue cases per 100,000 population,", uf_name),
        x = "epidemiological week",
        y = "cases") +
   scale_x_date(date_labels = "%Y-%m-%d", 
                date_breaks = "24 weeks") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) 
 
print(p)
```

### Validation test 1

Predict the weekly number of dengue cases by state (UF) in the
2022-2023 season [EW 41 2022- EW40 2023], using data covering the period from EW
01 2010 to EW 25 2022;

```{r, warning=FALSE, message=FALSE}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2022 | (Year == 2022 & week <= 26)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE") 
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2023-10-01") #EW40/2023
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2023-10-01")) #EW40/2023

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2022 & EW >= 40) | (Year == 2023 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) + geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )


filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation1 = summarised_scores
melhor_modelo_validacao1 <- best_models$best_wis_model
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```

### Validation test 2

Predict the weekly number of dengue cases by state (UF) in the
2023-2024 season [EW 41 2023- EW40 2024], using data covering the period from EW
01 2010 to EW 25 2023;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2023 | (Year == 2023 & week <= 25)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2024-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2024-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2023 <- pop %>%
  filter(Year == 2023, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2023, sum(Year == 2023)), rep(pop_2024, sum(Year == 2024)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", "2024-07-31")),) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```


#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2023 & EW >= 40) | (Year == 2024 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, 
                aes(x = target_end_date, 
                    y = wis, 
                    color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )


filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation2 = summarised_scores
melhor_modelo_validacao2 <- best_models$best_wis_model
adicionar_resultado(uf_name, 
                    melhor_modelo_validacao1,
                    melhor_modelo_validacao2,
                    summarised_scores_validation1,
                    summarised_scores_validation2)
```


```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```

### Forecast

Predict the weekly number of dengue cases in Brazil, and by state (UF), in the
2024-2025 season [EW 41 2024- EW40 2025], using data covering the period from EW
01 2010 to EW 25 2024;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2024 | (Year == 2024 & week <= 25)))

```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2025-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2025-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2025 <- pop %>%
  filter(Year == 2025, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2024, sum(Year == 2024)), rep(pop_2025, sum(Year == 2025)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```


# Northeast 

## Ceará
### Data

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
uf_name <- "CE"
data <- read.table("dados_dengue_CE_10_24.csv", header = TRUE, sep = ",")
data <- distinct(data) %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(incidence_rate = (casos/pop)*1e5) %>% 
  transmute(
    data_iniSE = as.Date(data_iniSE),
    cases = casos,
    pop = pop,
    umidmed = umidmed,
    tempmed = tempmed,
    week = week,
    Year = Year,
    incidence_rate = incidence_rate
  )
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(data)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors_full <- create_latent_factors(agg_data, "cases")

latent_factors_full <- latent_factors_full %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(year = Year - min(Year) + 1) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")

p <- ggplot(agg_data, aes(x = as.Date(data_iniSE), y = cases/pop*1e5)) +
   geom_bar(stat = "identity", fill = "pink") +
   theme_minimal() +
   labs(title = paste("Dengue cases per 100,000 population,", uf_name),
        x = "epidemiological week",
        y = "cases") +
   scale_x_date(date_labels = "%Y-%m-%d", 
                date_breaks = "24 weeks") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) 
 
print(p)
```



### Validation test 1

Predict the weekly number of dengue cases by state (UF) in the
2022-2023 season [EW 41 2022- EW40 2023], using data covering the period from EW
01 2010 to EW 25 2022;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2022 | (Year == 2022 & week <= 26)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2023-10-01") #EW40/2023
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2023-10-01")) #EW40/2023

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2022 & EW >= 40) | (Year == 2023 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )

# Filtrando os dados para plotar apenas os melhores modelos
filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation1 = summarised_scores
melhor_modelo_validacao1 <- best_models$best_wis_model
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```


### Validation test 2

Predict the weekly number of dengue cases by state (UF) in the
2023-2024 season [EW 41 2023- EW40 2024], using data covering the period from EW
01 2010 to EW 25 2023;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2023 | (Year == 2023 & week <= 25)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2024-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2024-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2023 <- pop %>%
  filter(Year == 2023, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2023, sum(Year == 2023)), rep(pop_2024, sum(Year == 2024)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", "2024-07-31")),) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2023 & EW >= 40) | (Year == 2024 & EW <= 41))
  return(df)
 }

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )


filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation2 = summarised_scores
melhor_modelo_validacao2 <- best_models$best_wis_model
adicionar_resultado(uf_name, 
                    melhor_modelo_validacao1,
                    melhor_modelo_validacao2,
                    summarised_scores_validation1,
                    summarised_scores_validation2)

```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```


### Forecast

Predict the weekly number of dengue cases in Brazil, and by state (UF), in the
2024-2025 season [EW 41 2024- EW40 2025], using data covering the period from EW
01 2010 to EW 25 2024;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2024 | (Year == 2024 & week <= 25)))

```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2025-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2025-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2025 <- pop %>%
  filter(Year == 2025, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2024, sum(Year == 2024)), rep(pop_2025, sum(Year == 2025)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```


# Central-West
## Goiás

### Data

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
uf_name <- "GO"
data <- read.table("dados_dengue_GO_10_24.csv", header = TRUE, sep = ",")
data <- distinct(data) %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(incidence_rate = (casos/pop)*1e5) %>% 
  transmute(
    data_iniSE = as.Date(data_iniSE),
    cases = casos,
    pop = pop,
    umidmed = umidmed,
    tempmed = tempmed,
    week = week,
    Year = Year,
    incidence_rate = incidence_rate
  )
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(data)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors_full <- create_latent_factors(agg_data, "cases")

latent_factors_full <- latent_factors_full %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(year = Year - min(Year) + 1) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")

p <- ggplot(agg_data, aes(x = as.Date(data_iniSE), y = cases/pop*1e5)) +
   geom_bar(stat = "identity", fill = "pink") +
   theme_minimal() +
   labs(title = paste("Dengue cases per 100,000 population,", uf_name),
        x = "epidemiological week",
        y = "cases") +
   scale_x_date(date_labels = "%Y-%m-%d", 
                date_breaks = "24 weeks") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) 
 
print(p)
```



### Validation test 1

Predict the weekly number of dengue cases by state (UF) in the
2022-2023 season [EW 41 2022- EW40 2023], using data covering the period from EW
01 2010 to EW 25 2022;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2022 | (Year == 2022 & week <= 26)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2023-10-01") #EW40/2023
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2023-10-01")) #EW40/2023

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2022 & EW >= 40) | (Year == 2023 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )

# Filtrando os dados para plotar apenas os melhores modelos
filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation1 = summarised_scores
melhor_modelo_validacao1 <- best_models$best_wis_model
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```


### Validation test 2

Predict the weekly number of dengue cases by state (UF) in the
2023-2024 season [EW 41 2023- EW40 2024], using data covering the period from EW
01 2010 to EW 25 2023;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2023 | (Year == 2023 & week <= 25)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2024-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2024-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2023 <- pop %>%
  filter(Year == 2023, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2023, sum(Year == 2023)), rep(pop_2024, sum(Year == 2024)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", "2024-07-31")),) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2023 & EW >= 40) | (Year == 2024 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )


filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation2 = summarised_scores
melhor_modelo_validacao2 <- best_models$best_wis_model
adicionar_resultado(uf_name, 
                    melhor_modelo_validacao1,
                    melhor_modelo_validacao2,
                    summarised_scores_validation1,
                    summarised_scores_validation2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```


### Forecast

Predict the weekly number of dengue cases in Brazil, and by state (UF), in the
2024-2025 season [EW 41 2024- EW40 2025], using data covering the period from EW
01 2010 to EW 25 2024;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2024 | (Year == 2024 & week <= 25)))

```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2025-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2025-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2025 <- pop %>%
  filter(Year == 2025, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2024, sum(Year == 2024)), rep(pop_2025, sum(Year == 2025)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```


# Southeast

## Minas Gerais

### Data

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
uf_name <- "MG"
data <- read.table("dados_dengue_MG_10_24.csv", header = TRUE, sep = ",")
data <- distinct(data) %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(incidence_rate = (casos/pop)*1e5) %>% 
  transmute(
    data_iniSE = as.Date(data_iniSE),
    cases = casos,
    pop = pop,
    umidmed = umidmed,
    tempmed = tempmed,
    week = week,
    Year = Year,
    incidence_rate = incidence_rate
  )
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(data)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors_full <- create_latent_factors(agg_data, "cases")

latent_factors_full <- latent_factors_full %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(year = Year - min(Year) + 1) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")

p <- ggplot(agg_data, aes(x = as.Date(data_iniSE), y = cases/pop*1e5)) +
   geom_bar(stat = "identity", fill = "pink") +
   theme_minimal() +
   labs(title = paste("Dengue cases per 100,000 population,", uf_name),
        x = "epidemiological week",
        y = "cases") +
   scale_x_date(date_labels = "%Y-%m-%d", 
                date_breaks = "24 weeks") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) 
 
print(p)
```



### Validation test 1

Predict the weekly number of dengue cases by state (UF) in the
2022-2023 season [EW 41 2022- EW40 2023], using data covering the period from EW
01 2010 to EW 25 2022;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2022 | (Year == 2022 & week <= 26)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2023-10-01") #EW40/2023
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2023-10-01")) #EW40/2023

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2022 & EW >= 40) | (Year == 2023 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )

filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation1 = summarised_scores
melhor_modelo_validacao1 <- best_models$best_wis_model
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```


### Validation test 2

Predict the weekly number of dengue cases by state (UF) in the
2023-2024 season [EW 41 2023- EW40 2024], using data covering the period from EW
01 2010 to EW 25 2023;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2023 | (Year == 2023 & week <= 25)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2024-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2024-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2023 <- pop %>%
  filter(Year == 2023, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2023, sum(Year == 2023)), rep(pop_2024, sum(Year == 2024)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", "2024-07-31")),) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2023 & EW >= 40) | (Year == 2024 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )


filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation2 = summarised_scores
melhor_modelo_validacao2 <- best_models$best_wis_model
adicionar_resultado(uf_name, 
                    melhor_modelo_validacao1,
                    melhor_modelo_validacao2,
                    summarised_scores_validation1,
                    summarised_scores_validation2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```

### Forecast

Predict the weekly number of dengue cases in Brazil, and by state (UF), in the
2024-2025 season [EW 41 2024- EW40 2025], using data covering the period from EW
01 2010 to EW 25 2024;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2024 | (Year == 2024 & week <= 25)))

```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2025-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2025-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2025 <- pop %>%
  filter(Year == 2025, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2024, sum(Year == 2024)), rep(pop_2025, sum(Year == 2025)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```


# South

## Paraná

### Data

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
uf_name <- "PR"
data <- read.table("dados_dengue_PR_10_24.csv", header = TRUE, sep = ",")
data <- distinct(data) %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(incidence_rate = (casos/pop)*1e5) %>% 
  transmute(
    data_iniSE = as.Date(data_iniSE),
    cases = casos,
    pop = pop,
    umidmed = umidmed,
    tempmed = tempmed,
    week = week,
    Year = Year,
    incidence_rate = incidence_rate
  )
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(data)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors_full <- create_latent_factors(agg_data, "cases")

latent_factors_full <- latent_factors_full %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  mutate(year = Year - min(Year) + 1) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")

p <- ggplot(agg_data, aes(x = as.Date(data_iniSE), y = cases/pop*1e5)) +
   geom_bar(stat = "identity", fill = "pink") +
   theme_minimal() +
   labs(title = paste("Dengue cases per 100,000 population,", uf_name),
        x = "epidemiological week",
        y = "cases") +
   scale_x_date(date_labels = "%Y-%m-%d", 
                date_breaks = "24 weeks") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10)) 
 
print(p)
```



### Validation test 1

Predict the weekly number of dengue cases by state (UF) in the
2022-2023 season [EW 41 2022- EW40 2023], using data covering the period from EW
01 2010 to EW 25 2022;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2022 | (Year == 2022 & week <= 26)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2023-10-01") #EW40/2023
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2023-10-01")) #EW40/2023

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test1_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2022 & EW >= 40) | (Year == 2023 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )

# Filtrando os dados para plotar apenas os melhores modelos
filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation1 = summarised_scores
melhor_modelo_validacao1 <- best_models$best_wis_model
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```


### Validation test 2

Predict the weekly number of dengue cases by state (UF) in the
2023-2024 season [EW 41 2023- EW40 2024], using data covering the period from EW
01 2010 to EW 25 2023;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2023 | (Year == 2023 & week <= 25)))
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2024-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2024-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
pop_nas <- rep(NA, num_semanas)
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2023 <- pop %>%
  filter(Year == 2023, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2023, sum(Year == 2023)), rep(pop_2024, sum(Year == 2024)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)
latent_factors$pop <- na.locf(latent_factors$pop, na.rm = FALSE)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df1 <- df1  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df1, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f1 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.1,, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f1)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r}
write.table(
  df1 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model1.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                  limits = as.Date(c("2021-12-31", "2024-07-31")),) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
df2 <- df2  %>%
  filter(!is.na(predict_upper1) & !is.na(predict_lower1) & !is.na(predict_mean1)) %>%
  mutate(
    diff_interval = (predict_upper1 - predict_lower1) / predict_mean1
  )


p <- ggplot(df2, aes(x = data_iniSE, y = diff_interval)) +
  geom_line(color = "blue") +
  labs(
    x = "Date",
    y = "IC/mean",
    title = "IC/mean"
  ) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.major.x = element_blank(),  
        panel.grid.minor.x = element_blank())


print(p)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
latent_factors_fit <- latent_factors_full_v1
model_f2 <- fit_model(latent_factors_fit, model_type=NULL, custom_formula = formula.2, metric = "cases")
fit_res <- fitted(latent_factors_fit, model_f2)

latent_factors_fit$fit <- fit_res$fit
latent_factors_fit$ufit <- fit_res$ufit
latent_factors_fit$lfit <- fit_res$lfit

p <- ggplot(latent_factors_fit, aes(x = data_iniSE, y = ((y/pop) * 1e+05))) + geom_bar(stat = "identity",
    aes(fill = "Observed cases"), color = NA) + geom_line(aes(y = fit, color = "Estimated cases"),
    linetype = "dashed") + geom_ribbon(aes(ymin = lfit, ymax = ufit, fill = "Credible Interval"),
    alpha = 0.5) + labs(x = "Epidemiological Week", y = "Dengue cases per 100,000 inhabitants",
    title = paste("Fitted and observed dengue cases in", uf_name)) + scale_x_date(date_labels = "%Y-%m-%d",
    date_breaks = "24 weeks") + scale_fill_manual(name = "Legend", values = c(`Observed cases` = "lightblue",
    `Credible Interval` = "grey70")) + scale_color_manual(name = "Legend", values = "blue",
    labels = "Estimated cases") + theme_bw() + theme(axis.text.x = element_text(angle = 90,
    hjust = 1))

p
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
results_f1_week <- extract_credible_intervals(model_f1$marginals.random, "week", "Model f1")
results_f2_week <- extract_credible_intervals(model_f2$marginals.random, "week", "Model f2")

results_f1_year <- extract_credible_intervals(model_f1$marginals.random, "year", "Model f1")
results_f2_year <- extract_credible_intervals(model_f2$marginals.random, "year", "Model f2")

results_combined_week <- rbind(results_f1_week, results_f2_week)
results_combined_year <- rbind(results_f1_year, results_f2_year)

plot_week <- ggplot(results_combined_week, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Week",
       x = "Week",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_week)

plot_year <- ggplot(results_f1_year, aes(x = Effect, y = Median, fill = Model, color = Model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), alpha = 0.2) +
  labs(title = "Median and 95% Credible Interval of Random Effects - Year",
       x = "Year",
       y = "Random Effect Value") +
  theme_minimal() +
  theme(legend.position = "top")

print(plot_year)
```

```{r}
write.table(
  df2 %>%
    select(data_iniSE, predict_mean1, predict_lower1, predict_upper1) %>%
    rename(
      date = data_iniSE,
      mean_prediction = predict_mean1,
      lower_interval = predict_lower1,
      upper_interval = predict_upper1
    ) %>%
    mutate(adm_1 = uf_name),
  file = "validation_test2_model2.csv",
  row.names = FALSE,
  col.names = FALSE,
  append = TRUE,
  sep = ","
)
```

#### *Model comparison*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
 add_year_ew_and_filter <- function(df) {
  df <- df %>%
    mutate(
      Year = year(data_iniSE),
      EW = epiweek(data_iniSE)
    ) %>%
    filter((Year == 2023 & EW >= 40) | (Year == 2024 & EW <= 41))
  return(df)
}

df1 <- add_year_ew_and_filter(df1)
df2 <- add_year_ew_and_filter(df2)
df1$model <- "Model 1"
df2$model <- "Model 2"

combined_df <- bind_rows(df1, df2)

combined_df <- combined_df %>%
  rename(
    target_end_date = data_iniSE
    )

combined_df <- combined_df %>%
  pivot_longer(
    cols = starts_with("predict_"),
    names_to = "type",
    values_to = "predicted"
  ) %>%
  mutate(
    quantile_level = case_when(
      type == "predict_mean1" ~ 0.5,
      type == "predict_lower1" ~ 0.025,
      type == "predict_upper1" ~ 0.975
    )
  ) %>%
  select(-type)

library(scoringutils)
scores <- combined_df %>%
  as_forecast(forecast_unit = c("target_end_date", "model"),
              forecast_type = "quantile") %>%
  score()

summarised_scores <- scores %>%
  summarise_scores(by = c("model", "target_end_date"))

p_wis <- ggplot(summarised_scores, aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()

print(p_wis)

best_models <- summarised_scores %>%
  group_by(model) %>%
  summarise(
    total_wis = sum(wis),
    total_overprediction = sum(overprediction),
    total_underprediction = sum(underprediction),
    total_dispersion = sum(dispersion)
  ) %>%
  summarise(
    best_wis_model = model[which.min(total_wis)],
    best_overprediction_model = model[which.min(total_overprediction)],
    best_underprediction_model = model[which.min(total_underprediction)],
    best_dispersion_model = model[which.min(total_dispersion)]
  )


filtered_scores <- summarised_scores %>%
  filter(model %in% c(
    best_models$best_wis_model,
    best_models$best_overprediction_model,
    best_models$best_underprediction_model,
    best_models$best_dispersion_model
  ))

# Criando os plots
p_wis <- ggplot(filtered_scores %>% filter(model == best_models$best_wis_model), aes(x = target_end_date, y = wis, color = model)) +
  geom_line() +
  labs(title = "WIS", x = "Data Alvo", y = "WIS") +
  theme_minimal()
print(p_wis)

best_models_wis <- summarised_scores %>%
  group_by(model) %>%
  summarise(total_wis = sum(wis)) %>%
  arrange(total_wis)

kable(best_models_wis, caption = "Model ranking") %>%
  kable_styling(full_width = FALSE, position = "center")

summarised_scores_validation2 = summarised_scores
melhor_modelo_validacao2 <- best_models$best_wis_model
adicionar_resultado(uf_name, 
                    melhor_modelo_validacao1,
                    melhor_modelo_validacao2,
                    summarised_scores_validation1,
                    summarised_scores_validation2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
model_list <- list(model_1 = model_f1, 
                   model_2 = model_f2)

generate_model_table(model_list)

par(mfrow = c(1, 2))
n = nrow(latent_factors_fit)
pit <- model_f1$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 1")
abline(0, 1)

n = nrow(latent_factors_fit)
pit <- model_f2$cpo$pit
uniquant <- (1:n)/(n + 1)
plot(uniquant, sort(pit), xlab = "uniform quantiles", ylab = "Sorted PIT values",
    main = "Model 2")
abline(0, 1)
par(mfrow = c(1, 1))
```

### Forecast

Predict the weekly number of dengue cases in Brazil, and by state (UF), in the
2024-2025 season [EW 41 2024- EW40 2025], using data covering the period from EW
01 2010 to EW 25 2024;

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
dados_filtrados <- data %>%
  filter((Year > 2010 | (Year == 2010 & week >= 1)) & 
         (Year < 2024 | (Year == 2024 & week <= 25)))

```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
agg_data <- aggregate_by_week(dados_filtrados)$aggregated_data_week %>%
 mutate(
    Year = lubridate::year(as.Date(data_iniSE))
  ) %>%
  left_join(
    pop %>% filter(UF == uf_name) %>% select(Year, Predicted_Population),
    by = "Year"
  ) %>%
  mutate(
    pop = Predicted_Population
  ) %>%
  select(-Predicted_Population)

latent_factors <- create_latent_factors(agg_data, "cases")

latent_factors <- latent_factors %>%
  mutate(
    Year = lubridate::year(as.Date(data_iniSE)),
    week = lubridate::epiweek(as.Date(data_iniSE)),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)) %>%
  left_join(agg_data %>% 
              select(data_iniSE, pop),
            by = "data_iniSE")
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
ultimas_observacoes <- latent_factors %>%
  slice_tail(n = 1)

ultima_data <- ultimas_observacoes$data_iniSE
data_alvo <- ymd("2025-10-05") #EW40/2024
num_semanas <- as.numeric(difftime(data_alvo, ultima_data, units = "weeks"))

latent_factors_full_v1 <- latent_factors_full %>%
  filter(data_iniSE <= ymd("2025-10-05")) #EW40/2024

data_novas_semanas <- ultima_data + weeks(1:num_semanas)
y_nas <- rep(NA, num_semanas)
rwtime <- ultimas_observacoes$rwtime + 1:num_semanas
seastime <- ultimas_observacoes$seastime + 1:num_semanas
artime <- ultimas_observacoes$artime + 1:num_semanas
Year <- year(data_novas_semanas)
week <- week(data_novas_semanas)

pop_2025 <- pop %>%
  filter(Year == 2025, UF == uf_name) %>%
  pull(Predicted_Population)

pop_2024 <- pop %>%
  filter(Year == 2024, UF == uf_name) %>%
  pull(Predicted_Population)

pop_nas <- c(rep(pop_2024, sum(Year == 2024)), rep(pop_2025, sum(Year == 2025)))

dataforecast <- data.frame(data_novas_semanas, y_nas, rwtime, seastime, artime, Year, week, pop_nas) 
colnames(dataforecast) <- colnames(latent_factors)

latent_factors <- bind_rows(latent_factors, dataforecast) %>%
  mutate(
    Year = year(data_iniSE),
    week = epiweek(data_iniSE),
    week = ifelse(week == 53, 52, week),
    Year = ifelse(week == 1 & month(data_iniSE) == 12, Year + 1, Year)
  ) %>%
  mutate(year = Year - min(Year) + 1)

horizon = round(num_semanas)
n_prediction = 1
```

#### *Model 1 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# model 1
formula.1 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "iid", constr = T)

forecast_f1 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.1,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f1)){
    forecast_f1[[i]]$pred.mean[forecast_f1[[i]]$pred.mean == 0] <- NA
    forecast_f1[[i]]$pred.lower[forecast_f1[[i]]$pred.lower == 0] <- NA
    forecast_f1[[i]]$pred.upper[forecast_f1[[i]]$pred.upper == 0] <- NA
}
  
  df1 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df1$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df1 <- rbind(df1, na_fill)
  
  for (i in 1:length(forecast_f1)) {
    df1[paste0("predict_mean", i)] <-  forecast_f1[[i]]$pred.mean
    df1[paste0("predict_lower", i)] <-  forecast_f1[[i]]$pred.lower
    df1[paste0("predict_upper", i)] <-  forecast_f1[[i]]$pred.upper
}
  
  p <- ggplot(df1, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f1)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 1") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

#### *Model 2 - Weekly and yearly components*

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
# Model 2
formula.2 <- y ~ f(week, model = "ar1", constr = TRUE, cyclic = TRUE) +
   f(year, model = "rw1", constr = T) 

forecast_f2 <- in.sample.multiple.forecast.dengue(latent_factors, 
                                                  horizon, 
                                                  n_prediction,
                                                  model_type=NULL,
                                                  custom_formula = formula.2,
                                                  metric = "cases")

latent_factors_full_v1$observed <- (latent_factors_full_v1$y / latent_factors_full_v1$pop) * 1e5
  for (i in 1:length(forecast_f2)){
    forecast_f2[[i]]$pred.mean[forecast_f2[[i]]$pred.mean == 0] <- NA
    forecast_f2[[i]]$pred.lower[forecast_f2[[i]]$pred.lower == 0] <- NA
    forecast_f2[[i]]$pred.upper[forecast_f2[[i]]$pred.upper == 0] <- NA
}
  
  df2 <- data.frame(data_iniSE = latent_factors_full_v1$data_iniSE, 
                   observed = latent_factors_full_v1$observed)
  
  dates_faltantes <- latent_factors$data_iniSE[!latent_factors$data_iniSE %in% df2$data_iniSE]
  
  na_fill <- data.frame(
  data_iniSE = dates_faltantes,
  observed = NA
  )

  df2 <- rbind(df2, na_fill)
  
  for (i in 1:length(forecast_f2)) {
    df2[paste0("predict_mean", i)] <-  forecast_f2[[i]]$pred.mean
    df2[paste0("predict_lower", i)] <-  forecast_f2[[i]]$pred.lower
    df2[paste0("predict_upper", i)] <-  forecast_f2[[i]]$pred.upper
}
  
  p <- ggplot(df2, aes(x = data_iniSE)) +
    geom_line(aes(y = observed), color = "red")+
    geom_ribbon(aes(ymin = 0, ymax = observed), fill = "red", alpha = 0.5)+
    geom_ribbon(aes(ymin = observed, ymax = Inf), fill = "darkred", alpha = 0.35)
    
  
 
  for (i in 1:length(forecast_f2)) {
    p <- p +
      geom_pointrange(aes_string(y = paste0("predict_mean", i),
                                 ymin = paste0("predict_lower", i),
                                 ymax = paste0("predict_upper", i)), color = "black")


  }
  
  p <- p +
    scale_x_date(date_labels = "%Y-%m-%d", 
                 date_breaks = "4 weeks",
                 limits = as.Date(c("2021-12-31", data_alvo))) +
    labs(x = "Epidemiological Week", 
         y = "Dengue cases per 100,000 inhabitants",
         title = "Observed vs Predicted Values with Credible Intervals \nModel 2") +
    theme_bw(base_size = 16) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1),
          panel.grid.major.x = element_blank(),  
          panel.grid.minor.x = element_blank())

p
```

# Summary

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, dpi=300}
colnames(resultados_melhores_modelos) <- c("State", "Validation test 1", "Validation test 2", "WIS Validation test 1", "WIS Validation test 2", "Delta WIS Validation test 1", "Delta WIS Validation test 2")

kable(resultados_melhores_modelos, caption = "Best models by state and validation test") %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  column_spec(2, bold = TRUE, background = "lightblue") %>%
  column_spec(3, bold = TRUE, background = "lightgreen")
```

